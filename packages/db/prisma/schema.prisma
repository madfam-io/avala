// AVALA Database Schema - Phase 0
// Multi-tenant SaaS with Row-Level Security
generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT & IDENTITY
// ============================================

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  plan      Plan     @default(BASIC)
  status    TenantStatus @default(ACTIVE)
  subscriptionStatus SubscriptionStatus @default(TRIALING) @map("subscription_status")
  settings  Json     @default("{}")

  // Mexican Legal/Tax Compliance (DC-3/STPS)
  rfc       String?  // Registro Federal de Contribuyentes (company tax ID)
  legalName String?  @map("legal_name") // Official registered company name
  representativeName String? @map("representative_name") // Legal representative for DC-3

  // Janua multi-provider billing (Conekta for MX, Polar for international)
  januaCustomerId   String?  @unique @map("janua_customer_id")
  billingProvider   String?  @map("billing_provider") // 'conekta' | 'polar' | 'stripe'
  countryCode       String?  @map("country_code") // ISO country code for billing routing
  billingEmail      String?  @map("billing_email") // Billing contact email

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users              User[]
  competencyStandards CompetencyStandard[]
  courses            Course[]
  paths              Path[]
  assessments        Assessment[]
  portfolios         Portfolio[]
  dc3Records         DC3[]
  lftPlans           LFTPlan[]
  sirceExports       SIRCEExport[]
  credentials        Credential[]
  auditLogs          AuditLog[]
  events             Event[]

  @@map("tenants")
  @@index([slug])
  @@index([status])
}

enum Plan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELLED
  PAUSED
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  email     String
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  role      Role     @default(TRAINEE)
  status    UserStatus @default(ACTIVE)

  // Authentication
  passwordHash String? @map("password_hash")

  // Mexican Compliance (DC-3/SIRCE/LFT)
  curp      String?  @unique // Clave Única de Registro de Población
  rfc       String?  // Registro Federal de Contribuyentes

  // SSO
  ssoSubject String?  @map("sso_subject")
  ssoProvider String? @map("sso_provider")

  // Metadata
  metadata  Json     @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  tenant              Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // As trainee
  enrollments         Enrollment[]
  courseEnrollments   CourseEnrollment[] @relation("UserCourseEnrollments")
  attempts            Attempt[]
  artifacts           Artifact[]
  portfolios          Portfolio[]
  credentialsReceived Credential[]

  // As instructor/assessor
  coursesOwned        Course[] @relation("CourseOwner")
  assessmentsCreated  Assessment[] @relation("AssessmentCreator")
  attemptsAssessed    Attempt[] @relation("AttemptAssessor")
  artifactsSigned     Artifact[] @relation("ArtifactSigner")

  // Audit
  auditLogsActor      AuditLog[]

  @@unique([tenantId, email])
  @@map("users")
  @@index([tenantId, role])
  @@index([tenantId, status])
  @@index([ssoSubject])
}

enum Role {
  ADMIN
  COMPLIANCE_OFFICER
  ECE_OC_ADMIN
  ASSESSOR
  INSTRUCTOR
  SUPERVISOR
  TRAINEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================
// COMPETENCY STANDARDS (EC/CONOCER)
// ============================================

model CompetencyStandard {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  // EC Metadata
  issuer      String   // e.g., "CONOCER"
  code        String   // e.g., "EC0217.01"
  title       String
  version     String
  locale      String   @default("es-MX")

  // Structure snapshot (for version pinning)
  structure   Json     // Full EC structure as JSON

  status      StandardStatus @default(ACTIVE)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  elements    Element[]
  courses     Course[] @relation("CourseStandards")

  @@unique([tenantId, code, version])
  @@map("competency_standards")
  @@index([tenantId, status])
  @@index([code])
}

enum StandardStatus {
  ACTIVE
  DEPRECATED
  ARCHIVED
}

model Element {
  id          String   @id @default(uuid()) @db.Uuid
  standardId  String   @map("standard_id") @db.Uuid

  index       Int      // Position within standard
  title       String
  description String?  @db.Text

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  standard    CompetencyStandard @relation(fields: [standardId], references: [id], onDelete: Cascade)
  criteria    Criterion[]

  @@map("elements")
  @@index([standardId, index])
}

model Criterion {
  id          String   @id @default(uuid()) @db.Uuid
  elementId   String   @map("element_id") @db.Uuid

  type        CriterionType
  code        String   // e.g., "1.1", "D1", "C2"
  text        String   @db.Text
  weight      Float    @default(1.0)

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  element     Element @relation(fields: [elementId], references: [id], onDelete: Cascade)

  // Mappings
  lessons     LessonCriterion[]
  rubrics     Rubric[]
  attemptScores Json?  // Stores score data per attempt

  @@map("criteria")
  @@index([elementId])
}

enum CriterionType {
  DESEMPENO   // Performance
  CONOCIMIENTO // Knowledge
  PRODUCTO    // Product
  ACTITUD     // Attitude (extension)
}

// ============================================
// LEARNING & AUTHORING
// ============================================

model Course {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  code        String   @unique // Course code (e.g., "ALINEACION-001")
  title       String
  description String?  @db.Text
  durationHours Int    @map("duration_hours") // Total duration in hours (required for DC-3)
  version     String   @default("1.0")
  status      CourseStatus @default(DRAFT)

  ownerId     String   @map("owner_id") @db.Uuid

  // EC Alignment
  ecCodes     String[] @map("ec_codes") // Array of EC codes

  // Mexican Compliance (DC-3/STPS)
  stpsRegistrationNumber String? @map("stps_registration_number") // STPS course registration number

  metadata    Json     @default("{}")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner       User @relation("CourseOwner", fields: [ownerId], references: [id])
  standards   CompetencyStandard[] @relation("CourseStandards")
  modules     Module[]
  enrollments CourseEnrollment[] @relation("CourseEnrollments")
  assessments Assessment[]
  pathItems   PathItem[]
  dc3Records  DC3[]

  @@map("courses")
  @@index([tenantId, status])
  @@index([ownerId])
  @@index([code])
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Module {
  id          String   @id @default(uuid()) @db.Uuid
  courseId    String   @map("course_id") @db.Uuid

  title       String
  order       Int

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@map("modules")
  @@index([courseId, order])
}

model Lesson {
  id          String   @id @default(uuid()) @db.Uuid
  moduleId    String   @map("module_id") @db.Uuid

  title       String
  order       Int      // Order within module
  content     String?  @db.Text // Lesson text content (description, instructions, etc.)
  videoUrl    String?  @map("video_url") // Video URL (YouTube, Vimeo, etc.)
  contentRef  String?  @map("content_ref") // S3 path or URL for additional materials
  durationMin Int?     @map("duration_min")

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  module      Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  criteria    LessonCriterion[]
  progress    LessonProgress[]
  attendance  Attendance[]

  @@map("lessons")
  @@index([moduleId, order])
}

// Join table: Lesson <-> Criterion mapping
model LessonCriterion {
  id          String   @id @default(uuid()) @db.Uuid
  lessonId    String   @map("lesson_id") @db.Uuid
  criterionId String   @map("criterion_id") @db.Uuid

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  lesson      Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  criterion   Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)

  @@unique([lessonId, criterionId])
  @@map("lesson_criteria")
  @@index([lessonId])
  @@index([criterionId])
}

// ============================================
// PATHS & ENROLLMENT
// ============================================

model Path {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  title       String
  description String?  @db.Text

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items       PathItem[]
  enrollments Enrollment[]

  @@map("paths")
  @@index([tenantId])
}

model PathItem {
  id          String   @id @default(uuid()) @db.Uuid
  pathId      String   @map("path_id") @db.Uuid
  courseId    String   @map("course_id") @db.Uuid

  order       Int
  required    Boolean  @default(true)

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  path        Path @relation(fields: [pathId], references: [id], onDelete: Cascade)
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("path_items")
  @@index([pathId, order])
}

model Enrollment {
  id          String   @id @default(uuid()) @db.Uuid
  pathId      String   @map("path_id") @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid
  supervisorId String? @map("supervisor_id") @db.Uuid

  status      EnrollmentStatus @default(ACTIVE)

  startedAt   DateTime @default(now()) @map("started_at")
  dueAt       DateTime? @map("due_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  path        Path @relation(fields: [pathId], references: [id], onDelete: Cascade)
  trainee     User @relation(fields: [traineeId], references: [id], onDelete: Cascade)

  @@map("enrollments")
  @@index([pathId])
  @@index([traineeId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// COURSE ENROLLMENT & PROGRESS (Phase 3-A)
// ============================================

model CourseEnrollment {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  courseId    String   @map("course_id") @db.Uuid

  status      CourseEnrollmentStatus @default(IN_PROGRESS)

  enrolledAt  DateTime @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  user         User @relation("UserCourseEnrollments", fields: [userId], references: [id], onDelete: Cascade)
  course       Course @relation("CourseEnrollments", fields: [courseId], references: [id], onDelete: Cascade)
  progress     LessonProgress[]
  certificates Certificate[]

  @@unique([userId, courseId])
  @@map("course_enrollments")
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

enum CourseEnrollmentStatus {
  IN_PROGRESS
  COMPLETED
}

model LessonProgress {
  id            String   @id @default(uuid()) @db.Uuid
  enrollmentId  String   @map("enrollment_id") @db.Uuid
  lessonId      String   @map("lesson_id") @db.Uuid

  status        ProgressStatus @default(NOT_STARTED)
  completedAt   DateTime? @map("completed_at")
  viewedAt      DateTime? @map("viewed_at") // First time lesson was opened

  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  enrollment    CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson        Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
  @@index([enrollmentId])
  @@index([lessonId])
  @@index([status])
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// ============================================
// CERTIFICATES & DC-3 (Phase 3-B)
// ============================================

model Certificate {
  id            String   @id @default(uuid()) @db.Uuid
  enrollmentId  String   @map("enrollment_id") @db.Uuid

  // Public certificate identifier (for verification)
  certificateUuid String  @unique @default(uuid()) @map("certificate_uuid") @db.Uuid

  // PDF storage
  pdfPath       String?  @map("pdf_path") // S3 key or local file path

  // DC-3 specific fields
  folio         String?  @unique // DC-3 folio number (sequential or formatted)

  // Issuance tracking
  issuedAt      DateTime @default(now()) @map("issued_at")
  issuedBy      String?  @map("issued_by") @db.Uuid // User ID of issuer (admin/system)

  // Revocation (for compliance audits)
  revokedAt     DateTime? @map("revoked_at")
  revokedBy     String?   @map("revoked_by") @db.Uuid
  revokedReason String?   @map("revoked_reason") @db.Text

  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  enrollment    CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map("certificates")
  @@index([enrollmentId])
  @@index([certificateUuid])
  @@index([folio])
  @@index([issuedAt])
}

// ============================================
// ASSESSMENT & PORTFOLIO
// ============================================

model Assessment {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  courseId    String?  @map("course_id") @db.Uuid

  title       String
  method      AssessmentMethod
  policyJson  Json     @default("{}") @map("policy_json")

  creatorId   String   @map("creator_id") @db.Uuid

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  course      Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  creator     User @relation("AssessmentCreator", fields: [creatorId], references: [id])
  rubrics     Rubric[]
  attempts    Attempt[]

  @@map("assessments")
  @@index([tenantId])
  @@index([courseId])
}

enum AssessmentMethod {
  QUIZ
  OBSERVATION
  INTERVIEW
  TASK
  VIDEO
  PORTFOLIO_REVIEW
}

model Rubric {
  id          String   @id @default(uuid()) @db.Uuid
  assessmentId String  @map("assessment_id") @db.Uuid
  criterionId String   @map("criterion_id") @db.Uuid

  scaleMin    Float    @map("scale_min")
  scaleMax    Float    @map("scale_max")
  descriptors Json     @default("[]") // Array of level descriptors

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  criterion   Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, criterionId])
  @@map("rubrics")
  @@index([assessmentId])
}

model Attempt {
  id          String   @id @default(uuid()) @db.Uuid
  assessmentId String  @map("assessment_id") @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid
  assessorId  String?  @map("assessor_id") @db.Uuid

  // Scores stored as JSON: { criterionId: score, ... }
  scoreJson   Json     @default("{}") @map("score_json")

  status      AttemptStatus @default(IN_PROGRESS)

  startedAt   DateTime @default(now()) @map("started_at")
  finishedAt  DateTime? @map("finished_at")

  // Relations
  assessment  Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  trainee     User @relation(fields: [traineeId], references: [id], onDelete: Cascade)
  assessor    User? @relation("AttemptAssessor", fields: [assessorId], references: [id])

  @@map("attempts")
  @@index([assessmentId])
  @@index([traineeId])
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
  CANCELLED
}

model Artifact {
  id          String   @id @default(uuid()) @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid
  assessmentId String? @map("assessment_id") @db.Uuid

  type        ArtifactType
  ref         String   // S3 path, URL, or text reference
  hash        String   // SHA-256 hash for integrity

  signerId    String?  @map("signer_id") @db.Uuid
  signedAt    DateTime? @map("signed_at")

  metadata    Json     @default("{}")

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  trainee     User @relation(fields: [traineeId], references: [id], onDelete: Cascade)
  signer      User? @relation("ArtifactSigner", fields: [signerId], references: [id])
  portfolios  PortfolioArtifact[]

  @@map("artifacts")
  @@index([traineeId])
  @@index([hash])
}

enum ArtifactType {
  FILE
  VIDEO
  URL
  NOTE
  OBSERVATION
}

model Portfolio {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid

  title       String?
  status      PortfolioStatus @default(DRAFT)
  summaryJson Json     @default("{}") @map("summary_json")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  trainee     User @relation(fields: [traineeId], references: [id], onDelete: Cascade)
  artifacts   PortfolioArtifact[]

  @@map("portfolios")
  @@index([tenantId])
  @@index([traineeId])
}

enum PortfolioStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
  REJECTED
}

// Join table: Portfolio <-> Artifact
model PortfolioArtifact {
  id          String   @id @default(uuid()) @db.Uuid
  portfolioId String   @map("portfolio_id") @db.Uuid
  artifactId  String   @map("artifact_id") @db.Uuid

  order       Int      @default(0)
  notes       String?  @db.Text

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  artifact    Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, artifactId])
  @@map("portfolio_artifacts")
  @@index([portfolioId])
}

model Attendance {
  id          String   @id @default(uuid()) @db.Uuid
  lessonId    String   @map("lesson_id") @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid

  date        DateTime @db.Date
  status      AttendanceStatus
  minutes     Int?

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  lesson      Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, traineeId, date])
  @@map("attendance")
  @@index([lessonId])
  @@index([traineeId])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// ============================================
// COMPLIANCE (Placeholder for Phase 1)
// ============================================

model DC3 {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid
  courseId    String   @map("course_id") @db.Uuid

  serial      String   @unique
  pdfRef      String?  @map("pdf_ref")
  status      DC3Status @default(ISSUED)

  issuedAt    DateTime @default(now()) @map("issued_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  course      Course @relation(fields: [courseId], references: [id])

  @@map("dc3_records")
  @@index([tenantId])
  @@index([serial])
}

enum DC3Status {
  ISSUED
  REVOKED
}

model LFTPlan {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  year        Int
  businessUnit String  @map("business_unit")
  programJson Json     @default("{}") @map("program_json")

  lockedAt    DateTime? @map("locked_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, year, businessUnit])
  @@map("lft_plans")
  @@index([tenantId])
}

model SIRCEExport {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  period      String
  fileRef     String   @map("file_ref")
  status      ExportStatus @default(PENDING)

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sirce_exports")
  @@index([tenantId])
}

enum ExportStatus {
  PENDING
  COMPLETED
  FAILED
}

// ============================================
// CREDENTIALS (Placeholder for Phase 2)
// ============================================

model Credential {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  traineeId   String   @map("trainee_id") @db.Uuid

  type        CredentialType @default(OBV3)
  payloadJson Json     @default("{}") @map("payload_json")
  status      CredentialStatus @default(ACTIVE)

  issuedAt    DateTime @default(now()) @map("issued_at")
  expiresAt   DateTime? @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  trainee     User @relation(fields: [traineeId], references: [id], onDelete: Cascade)

  @@map("credentials")
  @@index([tenantId])
  @@index([traineeId])
}

enum CredentialType {
  OBV3
  VC
}

enum CredentialStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

// ============================================
// RENEC DATA (CONOCER Registry)
// ============================================

// EC Standards from RENEC (cached/synced from CONOCER)
model RenecEC {
  id            String   @id @default(uuid()) @db.Uuid

  // Core EC identifiers
  ecClave       String   @unique @map("ec_clave") // e.g., "EC0217.01"
  titulo        String
  version       String   @default("01")

  // Status
  vigente       Boolean  @default(true)
  fechaPublicacion DateTime? @map("fecha_publicacion")
  fechaFinVigencia DateTime? @map("fecha_fin_vigencia")

  // Classification
  sector        String?
  nivelCompetencia Int?  @map("nivel_competencia") // 1-5

  // Detailed structure (JSON for flexibility)
  proposito     String?  @db.Text
  competencias  Json     @default("[]") // Array of competency descriptions
  elementosJson Json     @default("[]") @map("elementos_json") // Full element structure
  critDesempeno Json     @default("[]") @map("crit_desempeno")
  critConocimiento Json  @default("[]") @map("crit_conocimiento")
  critProducto  Json     @default("[]") @map("crit_producto")

  // Source tracking
  sourceUrl     String?  @map("source_url")
  contentHash   String?  @map("content_hash") // SHA256 for change detection
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  accreditations RenecAccreditation[]
  centerOfferings RenecCenterOffering[]

  @@map("renec_ec")
  @@index([ecClave])
  @@index([vigente])
  @@index([sector])
}

// ECE/OC Certifying Entities from RENEC
model RenecCertifier {
  id            String   @id @default(uuid()) @db.Uuid

  // Core identifiers
  certId        String   @unique @map("cert_id") // ID from RENEC
  tipo          RenecCertifierType @default(ECE)
  razonSocial   String   @map("razon_social")
  nombreComercial String? @map("nombre_comercial")

  // Status
  activo        Boolean  @default(true)

  // Contact
  direccion     String?  @db.Text
  telefono      String?
  email         String?
  sitioWeb      String?  @map("sitio_web")

  // Legal
  rfc           String?
  representanteLegal String? @map("representante_legal")

  // Location (normalized)
  estado        String?
  estadoInegi   String?  @map("estado_inegi") // 2-digit INEGI code
  municipio     String?

  // Source tracking
  sourceUrl     String?  @map("source_url")
  contentHash   String?  @map("content_hash")
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  accreditations RenecAccreditation[]
  centers       RenecCenter[]

  @@map("renec_certifiers")
  @@index([certId])
  @@index([tipo])
  @@index([activo])
  @@index([estadoInegi])
}

enum RenecCertifierType {
  ECE // Entidad de Certificación y Evaluación
  OC  // Organismo Certificador
}

// Accreditation relationship: Certifier <-> EC
model RenecAccreditation {
  id            String   @id @default(uuid()) @db.Uuid

  certifierId   String   @map("certifier_id") @db.Uuid
  ecId          String   @map("ec_id") @db.Uuid

  // Accreditation details
  fechaAcreditacion DateTime? @map("fecha_acreditacion")
  vigente       Boolean  @default(true)

  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  certifier     RenecCertifier @relation(fields: [certifierId], references: [id], onDelete: Cascade)
  ec            RenecEC @relation(fields: [ecId], references: [id], onDelete: Cascade)

  @@unique([certifierId, ecId])
  @@map("renec_accreditations")
  @@index([certifierId])
  @@index([ecId])
}

// Evaluation Centers from RENEC
model RenecCenter {
  id            String   @id @default(uuid()) @db.Uuid

  // Core identifiers
  centerId      String   @unique @map("center_id") // ID from RENEC
  certifierId   String?  @map("certifier_id") @db.Uuid // Parent ECE/OC

  nombre        String
  activo        Boolean  @default(true)

  // Contact
  direccion     String?  @db.Text
  telefono      String?
  email         String?

  // Location (normalized)
  estado        String?
  estadoInegi   String?  @map("estado_inegi")
  municipio     String?
  codigoPostal  String?  @map("codigo_postal")

  // Geolocation (for map/distance queries)
  latitud       Float?
  longitud      Float?
  geocodedAt    DateTime? @map("geocoded_at") // When lat/lng was resolved

  // Source tracking
  sourceUrl     String?  @map("source_url")
  contentHash   String?  @map("content_hash")
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  certifier     RenecCertifier? @relation(fields: [certifierId], references: [id], onDelete: SetNull)
  offerings     RenecCenterOffering[]

  @@map("renec_centers")
  @@index([centerId])
  @@index([certifierId])
  @@index([activo])
  @@index([estadoInegi])
  @@index([latitud, longitud])
}

// Center EC offerings (which ECs a center can evaluate)
model RenecCenterOffering {
  id            String   @id @default(uuid()) @db.Uuid

  centerId      String   @map("center_id") @db.Uuid
  ecId          String   @map("ec_id") @db.Uuid

  activo        Boolean  @default(true)

  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  center        RenecCenter @relation(fields: [centerId], references: [id], onDelete: Cascade)
  ec            RenecEC @relation(fields: [ecId], references: [id], onDelete: Cascade)

  @@unique([centerId, ecId])
  @@map("renec_center_offerings")
  @@index([centerId])
  @@index([ecId])
}

// Sync job tracking
model RenecSyncJob {
  id            String   @id @default(uuid()) @db.Uuid

  jobType       RenecSyncJobType @map("job_type")
  status        RenecSyncStatus @default(PENDING)

  // Statistics
  itemsProcessed Int     @default(0) @map("items_processed")
  itemsCreated  Int      @default(0) @map("items_created")
  itemsUpdated  Int      @default(0) @map("items_updated")
  itemsSkipped  Int      @default(0) @map("items_skipped")
  errors        Json     @default("[]")

  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")

  createdAt     DateTime @default(now()) @map("created_at")

  @@map("renec_sync_jobs")
  @@index([jobType])
  @@index([status])
  @@index([createdAt])
}

enum RenecSyncJobType {
  EC_STANDARDS
  CERTIFIERS
  CENTERS
  FULL_SYNC
}

enum RenecSyncStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================
// LEADS (RENEC Explorer Conversion)
// ============================================

model Lead {
  id            String   @id @default(uuid()) @db.Uuid

  // Contact info
  email         String
  name          String?
  phone         String?
  company       String?

  // Lead classification
  leadType      LeadType @default(INDIVIDUAL) @map("lead_type")
  source        String   @default("renec_explorer") // Source of the lead

  // Interest tracking
  interests     String[] @default([]) // Array: certification, training, dc3, compliance

  // Context (what they were looking at)
  ecCode        String?  @map("ec_code")
  certifierId   String?  @map("certifier_id") @db.Uuid
  centerId      String?  @map("center_id") @db.Uuid

  // UTM tracking
  utmSource     String?  @map("utm_source")
  utmMedium     String?  @map("utm_medium")
  utmCampaign   String?  @map("utm_campaign")

  // Status
  status        LeadStatus @default(NEW)
  notes         String?  @db.Text

  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  convertedAt   DateTime? @map("converted_at")

  @@map("leads")
  @@index([email])
  @@index([leadType])
  @@index([status])
  @@index([createdAt])
  @@index([ecCode])
}

enum LeadType {
  INDIVIDUAL
  ORGANIZATION
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  CLOSED
}

// ============================================
// SEARCH ANALYTICS
// ============================================

model SearchAnalytics {
  id            String   @id @default(uuid()) @db.Uuid

  // What was searched
  query         String?
  searchType    SearchType @default(GENERAL) @map("search_type")

  // Filters used
  filters       Json     @default("{}") // { vigente, sector, estado, etc. }

  // Results
  resultCount   Int      @default(0) @map("result_count")

  // User context (anonymous tracking)
  sessionId     String?  @map("session_id")
  userAgent     String?  @map("user_agent")
  ipHash        String?  @map("ip_hash") // Hashed IP for privacy

  // Location context
  userLat       Float?   @map("user_lat")
  userLng       Float?   @map("user_lng")
  userEstado    String?  @map("user_estado")

  // Timestamp
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("search_analytics")
  @@index([searchType])
  @@index([createdAt])
  @@index([query])
}

enum SearchType {
  GENERAL
  EC_STANDARDS
  CERTIFIERS
  CENTERS
  AUTOCOMPLETE
  NEARBY
}

// ============================================
// EVENTS & AUDIT
// ============================================

model Event {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  subjectType String   @map("subject_type")
  subjectId   String   @map("subject_id") @db.Uuid
  verb        String
  dataJson    Json     @default("{}") @map("data_json")

  timestamp   DateTime @default(now())

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("events")
  @@index([tenantId, timestamp])
  @@index([subjectType, subjectId])
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  actorId     String?  @map("actor_id") @db.Uuid

  action      String
  target      String
  diffJson    Json     @default("{}") @map("diff_json")

  timestamp   DateTime @default(now())

  // Relations
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor       User? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
  @@index([tenantId, timestamp])
  @@index([actorId])
}
