# ============================================
# AVALA LOCAL DEVELOPMENT (MADFAM SHARED INFRA)
# ============================================
# Connects to madfam-shared-network for:
# - PostgreSQL: madfam-postgres-shared:5432/avala_db
# - Redis: madfam-redis-shared:6379
# - MinIO: madfam-minio-shared:9000
# - MailHog: madfam-mailhog:1025
#
# Start shared infra first:
#   cd ~/labspace/solarpunk-foundry/ops/local
#   docker compose -f docker-compose.shared.yml up -d
# ============================================

name: avala-dev

services:
  # ==========================================
  # Avala API (NestJS)
  # ==========================================
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
    container_name: avala-api-dev
    environment:
      NODE_ENV: development
      PORT: 3000
      # Database - Shared PostgreSQL
      DATABASE_URL: postgresql://madfam:madfam_dev_password@madfam-postgres-shared:5432/avala_db?schema=public
      # Redis - Shared
      REDIS_URL: redis://:redis_dev_password@madfam-redis-shared:6379/4
      # MinIO/S3 - Shared
      S3_ENDPOINT: http://madfam-minio-shared:9000
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_BUCKET: avala-uploads
      # Janua Auth
      JANUA_URL: http://janua-api:4000
      JANUA_API_KEY: ${JANUA_API_KEY:-dev-api-key}
      JWT_SECRET: ${JWT_SECRET:-dev-shared-janua-secret-32chars!!}
      # Email - MailHog
      SMTP_HOST: madfam-mailhog
      SMTP_PORT: 1025
      SMTP_SECURE: "false"
    ports:
      - "3040:3000"
    volumes:
      - ./apps/api:/app/apps/api
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/api/node_modules
    depends_on:
      - worker
    networks:
      - madfam-shared-network
    restart: unless-stopped

  # ==========================================
  # Avala Web (Next.js)
  # ==========================================
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    container_name: avala-web-dev
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3040
      NEXT_PUBLIC_JANUA_URL: http://localhost:4000
    ports:
      - "3041:3000"
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/web/node_modules
    networks:
      - madfam-shared-network
    restart: unless-stopped

  # ==========================================
  # Avala Worker (Background Jobs)
  # ==========================================
  worker:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
    container_name: avala-worker-dev
    command: ["pnpm", "run", "worker:dev"]
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://madfam:madfam_dev_password@madfam-postgres-shared:5432/avala_db?schema=public
      REDIS_URL: redis://:redis_dev_password@madfam-redis-shared:6379/4
    volumes:
      - ./apps/api:/app/apps/api
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - madfam-shared-network
    restart: unless-stopped

# ==========================================
# Networks - Use External Shared Network
# ==========================================
networks:
  madfam-shared-network:
    external: true
